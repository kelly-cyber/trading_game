<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Options Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .option-form {
            display: none;
        }
        .active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Dice Options Trading Simulator</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row">
            <!-- Game Status -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">Game Status</div>
                    <div class="card-body">
                        <p><strong>Rolls:</strong> {{ rolls|join(', ') if rolls else 'No rolls yet' }}</p>
                        <p><strong>Current Total:</strong> {{ total }}</p>
                        
                        <form action="{{ url_for('roll_die') }}" method="post" class="mb-3">
                            <div class="input-group">
                                <input type="number" name="value" class="form-control" min="1" max="6" placeholder="Roll value (optional)">
                                <button type="submit" class="btn btn-primary">Roll Die</button>
                            </div>
                        </form>
                        
                        <form action="{{ url_for('reset') }}" method="post">
                            <button type="submit" class="btn btn-danger">Reset Game</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Portfolio -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">Portfolio</div>
                    <div class="card-body">
                        {% if simulator.portfolio.positions %}
                            <ul class="list-group mb-3">
                                {% for position, quantity, entry_price in simulator.portfolio.positions %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ position }}
                                        {% if entry_price is not none %}
                                            <span class="badge bg-info rounded-pill me-2">@ {{ "%.2f"|format(entry_price) }}</span>
                                        {% endif %}
                                        <span class="badge bg-primary rounded-pill">{{ quantity }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                            
                            <p><strong>Portfolio Value:</strong> {{ "%.2f"|format(portfolio_value) }}</p>
                            <p><strong>Delta:</strong> {{ "%.4f"|format(simulator.portfolio.delta()) }}</p>
                            <p><strong>Vega:</strong> {{ "%.4f"|format(simulator.portfolio.vega()) }}</p>
                            
                            {% if total_pnl is not none %}
                                <h5 class="mt-3">PNL after 2 rolls</h5>
                                <p class="fw-bold {{ 'text-success' if total_pnl > 0 else 'text-danger' if total_pnl < 0 else '' }}">
                                    Total PNL: {{ "%.2f"|format(total_pnl) }}
                                </p>
                                
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Position</th>
                                            <th>Entry</th>
                                            <th>Final</th>
                                            <th>PNL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for position, quantity, entry_price, current_value, pnl in position_pnls %}
                                            <tr>
                                                <td>{{ position }}</td>
                                                <td>{{ quantity }}</td>
                                                <td>{{ entry_price }}</td>
                                                <td>{{ current_value }}</td>
                                                <td>{{ pnl }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% endif %}
                        {% else %}
                            <p>No positions in portfolio</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Add Options -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">Add Position</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="option_selector" class="form-label">Option Type</label>
                            <select id="option_selector" class="form-select" onchange="showOptionForm()">
                                <option value="">Select option type</option>
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                                <option value="risk_reversal">Risk Reversal</option>
                                <option value="call_spread">Call Spread</option>
                                <option value="put_spread">Put Spread</option>
                                <option value="straddle">Straddle</option>
                                <option value="strangle">Strangle</option>
                            </select>
                        </div>
                        
                        <!-- Option Analytics Display -->
                        <div id="option-analytics" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-info text-white">Option Analytics</div>
                                <div class="card-body">
                                    <p><strong>Option:</strong> <span id="option-name"></span></p>
                                    <p><strong>Fair Value:</strong> <span id="fair-value"></span></p>
                                    <p><strong>Delta:</strong> <span id="option-delta"></span></p>
                                    <p><strong>Vega:</strong> <span id="option-vega"></span></p>
                                    <p><strong>Delta Neutral Quantity:</strong> <span id="delta-neutral-quantity"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Call Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="call-form" class="option-form">
                            <input type="hidden" name="option_type" value="call">
                            <div class="mb-3">
                                <label for="call_strike" class="form-label">Strike</label>
                                <input type="number" name="strike" id="call_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="call_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="call_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="call_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="call_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                        
                        <!-- Put Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="put-form" class="option-form">
                            <input type="hidden" name="option_type" value="put">
                            <div class="mb-3">
                                <label for="put_strike" class="form-label">Strike</label>
                                <input type="number" name="strike" id="put_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="put_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="put_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="put_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="put_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                        
                        <!-- Risk Reversal Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="risk_reversal-form" class="option-form">
                            <input type="hidden" name="option_type" value="risk_reversal">
                            <div class="mb-3">
                                <label for="rr_put_strike" class="form-label">Put Strike</label>
                                <input type="number" name="put_strike" id="rr_put_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="rr_call_strike" class="form-label">Call Strike</label>
                                <input type="number" name="call_strike" id="rr_call_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="rr_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="rr_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="rr_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="rr_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                        
                        <!-- Call Spread Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="call_spread-form" class="option-form">
                            <input type="hidden" name="option_type" value="call_spread">
                            <div class="mb-3">
                                <label for="cs_lower_strike" class="form-label">Lower Strike</label>
                                <input type="number" name="lower_strike" id="cs_lower_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="cs_higher_strike" class="form-label">Higher Strike</label>
                                <input type="number" name="higher_strike" id="cs_higher_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="cs_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="cs_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="cs_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="cs_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                        
                        <!-- Put Spread Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="put_spread-form" class="option-form">
                            <input type="hidden" name="option_type" value="put_spread">
                            <div class="mb-3">
                                <label for="ps_higher_strike" class="form-label">Higher Strike</label>
                                <input type="number" name="higher_strike" id="ps_higher_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="ps_lower_strike" class="form-label">Lower Strike</label>
                                <input type="number" name="lower_strike" id="ps_lower_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="ps_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="ps_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="ps_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="ps_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                        
                        <!-- Straddle Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="straddle-form" class="option-form">
                            <input type="hidden" name="option_type" value="straddle">
                            <div class="mb-3">
                                <label for="straddle_strike" class="form-label">Strike</label>
                                <input type="number" name="strike" id="straddle_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="straddle_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="straddle_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="straddle_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="straddle_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                        
                        <!-- Strangle Form -->
                        <form action="{{ url_for('add_option') }}" method="post" id="strangle-form" class="option-form">
                            <input type="hidden" name="option_type" value="strangle">
                            <div class="mb-3">
                                <label for="strangle_put_strike" class="form-label">Put Strike</label>
                                <input type="number" name="put_strike" id="strangle_put_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="strangle_call_strike" class="form-label">Call Strike</label>
                                <input type="number" name="call_strike" id="strangle_call_strike" class="form-control" min="2" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="strangle_quantity" class="form-label">Quantity</label>
                                <input type="number" name="quantity" id="strangle_quantity" class="form-control" value="1" required>
                            </div>
                            <div class="mb-3">
                                <label for="strangle_entry_price" class="form-label">Entry Price</label>
                                <input type="number" name="entry_price" id="strangle_entry_price" class="form-control" step="0.01" min="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info" onclick="showAnalytics(this.form)">Show Analytics</button>
                                <button type="submit" class="btn btn-success">Add to Portfolio</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showOptionForm() {
            // Hide all forms
            document.querySelectorAll('.option-form').forEach(form => {
                form.classList.remove('active');
            });
            
            // Show selected form
            const selectedOption = document.getElementById('option_selector').value;
            if (selectedOption) {
                document.getElementById(`${selectedOption}-form`).classList.add('active');
                
                // Hide analytics display when changing option type
                document.getElementById('option-analytics').style.display = 'none';
            }
        }
        
        function showAnalytics(form) {
            // Get the form data
            const formData = new FormData(form);
            
            // Make sure we have all required values for the option type
            let allFieldsFilled = true;
            form.querySelectorAll('input[type="number"]:not([name="quantity"]):not([name="entry_price"])').forEach(input => {
                if (!input.value) {
                    allFieldsFilled = false;
                }
            });
            
            if (!allFieldsFilled) {
                alert("Please fill in all strike price fields first");
                return; // Don't make the request if not all fields are filled
            }
            
            // Send request to get analytics
            fetch('/option_analytics', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Update the analytics display
                document.getElementById('option-name').textContent = data.option_name;
                document.getElementById('fair-value').textContent = data.fair_value;
                document.getElementById('option-delta').textContent = data.delta;
                document.getElementById('option-vega').textContent = data.vega;
                document.getElementById('delta-neutral-quantity').textContent = data.delta_neutral_quantity;
                
                // Show the analytics display
                document.getElementById('option-analytics').style.display = 'block';
                
                // Optionally update the quantity field with delta neutral quantity
                if (data.delta_neutral_quantity !== 0) {
                    const quantityInput = form.querySelector('input[name="quantity"]');
                    if (confirm(`Set quantity to delta-neutral value of ${data.delta_neutral_quantity}?`)) {
                        quantityInput.value = data.delta_neutral_quantity;
                    }
                }
                
                // Scroll to the analytics section
                document.getElementById('option-analytics').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while fetching analytics');
            });
        }
    </script>
</body>
</html> 